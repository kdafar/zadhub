--- Context from: GEMINI.md ---
# Project Overview: Multi-Tenant WhatsApp Platform

## Core Purpose
This is a Laravel-based backend for a multi-tenant WhatsApp messaging service. Its goal is to provide a scalable platform for various business types ('Service Types') to deploy and manage custom interactive WhatsApp 'Flows' for their clients ('Providers').

---

## Key Concepts & Terminology
- **Service Type:** The top-level business category (e.g., 'Food Delivery', 'Clinic Appointments', 'Retail'). This entity defines the master templates for flows, messages, and custom data fields for that business type.
- **Provider:** The end-customer or business using our platform (e.g., 'Slice Pizza', 'City Clinic'). A Provider belongs to exactly one `Service Type`.
- **Flow:** A Provider's unique, editable instance of a conversation. It is generated by copying a `Base Flow Template` when the provider is onboarded.
- **Base Flow Template:** The master, un-editable flow definition (stored as JSON) that lives on the `Service Type`. It acts as the starting point for all providers of that type.
- **Custom Attributes:** Dynamic data fields defined by a `Service Type` (e.g., a 'patient_id' field for clinics, or a 'table_number' for restaurants) that can be used in their flows.
- **FlowComponent:** Individual UI/logic blocks within a flow (e.g., Text Input, Dropdown, Date Picker).

---

## Main Workflow
1.  **Admin Onboarding:** An admin creates a `Service Type` and configures its `Base Flow Template`, `Custom Attributes`, and all necessary translated system messages (welcome, update, etc.).
2.  **Provider Onboarding:** An admin creates a `Provider` and assigns it to a `Service Type`. The system automatically **copies** the `Base Flow Template` to create a new, editable `Flow` record linked to this `Provider`.
3.  **Message Handling:** A WhatsApp message arrives at the webhook. The system identifies the `Provider`, loads their specific `Flow` and their `Service Type`'s configuration.
4.  **System Messages:** When a system message (like a welcome or update) is needed, the system uses the appropriate translated message template from the `Provider's` `Service Type`.

---

## Coding Style & Rules
- **Dependency Injection:** Always use constructor injection for services. Do not use `new Service()`.
- **Testing:** All new business logic should be covered by PestPHP tests.
- **Security:** All incoming webhooks must be validated using their signature. All user input must be validated.
- **Logging:** Log all important events and especially errors to help with debugging.
- **Translations:** All user-facing text should be translatable using Laravel's JSON translation features.

---

## Current Project Status
- **Core Engine:** The foundational logic for multi-step, branching conversational flows is complete. The system can successfully start a flow, process user replies, and navigate between screens.
- **WhatsApp API Integration:** The project now uses the `netflie/whatsapp-cloud-api` package for all outgoing WhatsApp communications. The `WhatsAppApiService` acts as a wrapper around this library, providing methods for sending various message types (text, images, documents, flows, etc.).
- **Database Schema:** The database schema is implemented, with all major models (`ServiceType`, `Provider`, `Flow`, `FlowVersion`, etc.) in place.
- **Admin Panel:** Basic Filament resources for managing core models have been created.
- **Onboarding & Routing:** The `ProviderOnboardingService` and the `TriggerResolver` for keyword-based routing are functional.
- **Security:** Webhook signature validation is implemented, using helpers from the new WhatsApp library where applicable.

---

## High-Level Goals (Next Steps)
1.  **Enhance the Flow Builder UI (Highest Priority):** The backend can now send many message types (images, documents, videos, etc.). The next critical step is to add corresponding components to the Flow Builder UI in Filament. This will allow admins to visually construct richer, more engaging flows.
2.  **Implement Message Template Sending:** The `WhatsAppApiService` can send pre-approved templates, but there is no UI or flow action to trigger this. A new 'Send Template' action should be added to the Flow Builder.
3.  **Implement Data Interpolation:** Update the `FlowRenderer` to substitute variables from the session `context` into message text (e.g., `Welcome, {{name}}!`). This is essential for personalization.
4.  **Develop an External API Adapter Strategy:** Refine the `FlowActionService` to create a more robust and pluggable pattern for making external API calls from within a flow (e.g., to fetch data from a provider's system).
5.  **Improve Fallback Handler:** The `WhatsAppMessageHandler` currently sends a generic fallback message. This should be improved to list the available keywords for the specific provider to better guide the user.

---

## Suggested Libraries & Tools
For future consideration, these packages could be highly beneficial for the project:

- **`spatie/laravel-medialibrary`**: As the platform grows, you'll need to handle media sent *by users* (e.g., images for support tickets). This library is the industry standard in the Laravel ecosystem for managing file uploads and associating them with models.
- **`spatie/laravel-activitylog`**: For a multi-tenant platform, having a clear audit trail is crucial. This package makes it incredibly easy to log all significant actions performed by users and admins.
- **`tenancy/multi-tenant`**: The project currently handles multi-tenancy manually by scoping queries with `provider_id`. For true data separation and scalability, a dedicated tenancy package like this one is the gold standard. It can automatically handle database connections, routing, and data scoping for each tenant.
- **`laravel/horizon`**: The project uses database queues. As traffic increases, you will need a more robust queue monitoring and management solution. Horizon provides a beautiful dashboard and code-driven configuration for your Redis queues.

--- End of Context from: GEMINI.md ---