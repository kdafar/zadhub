# Project Overview: Multi-Tenant WhatsApp Platform

## Core Purpose
This is a Laravel-based backend for a multi-tenant WhatsApp messaging service. Its goal is to provide a scalable platform for various business types ('Service Types') to deploy and manage custom interactive WhatsApp 'Flows' for their clients ('Providers').

---

## Key Concepts & Terminology
- **Service Type:** The top-level business category (e.g., 'Food Delivery', 'Clinic Appointments', 'Retail'). This entity defines the master templates for flows, messages, and custom data fields for that business type.
- **Provider:** The end-customer or business using our platform (e.g., 'Slice Pizza', 'City Clinic'). A Provider belongs to exactly one `Service Type`.
- **Flow:** A Provider's unique, editable instance of a conversation. It is generated by copying a `Base Flow Template` when the provider is onboarded.
- **Base Flow Template:** The master, un-editable flow definition (stored as JSON) that lives on the `Service Type`. It acts as the starting point for all providers of that type. These are now typically *imported directly from Meta*.
- **Custom Attributes:** Dynamic data fields defined by a `Service Type` (e.g., a 'patient_id' field for clinics, or a 'table_number' for restaurants) that can be used in their flows.
- **FlowComponent:** Individual UI/logic blocks within a flow (e.g., Text Input, Dropdown, Date Picker).
- **Automation:** A sequence of actions (e.g., sending messages, starting flows) triggered by external events from a Provider's system.
- **Automation Step:** An individual action within an Automation, which can include delays and specific configurations.

---

## Main Workflow
1.  **Admin Onboarding:** An admin creates a `Service Type` and configures its `Custom Attributes`. They then **import approved Message Templates and Flows directly from Meta** to serve as the base templates for this Service Type.
2.  **Provider Onboarding:** An admin creates a `Provider` and assigns it to a `Service Type`. The system automatically **copies the imported Base Flow Templates** to create new, editable `Flow` records linked to this `Provider`.
3.  **Message Handling (Conversational Flows):** A WhatsApp message arrives at the webhook. The system identifies the `Provider`, loads their specific `Flow` and their `Service Type`'s configuration, and manages the interactive conversation.
4.  **Event-Driven Automations:** An external system (e.g., a Provider's e-commerce platform) triggers an `Automation` via API. The platform executes a predefined sequence of `Automation Steps`, which can include sending message templates, starting conversational flows, or applying delays.
5.  **System Messages:** When a system message (like a welcome or update) is needed, the system uses the appropriate translated message template from the `Provider's` `Service Type`.

---

## Coding Style & Rules
- **Dependency Injection:** Always use constructor injection for services. Do not use `new Service()`.
- **Testing:** All new business logic should be covered by PestPHP tests.
- **Security:** All incoming webhooks must be validated using their signature. All user input must be validated.
- **Logging:** Log all important events and especially errors to help with debugging.
- **Translations:** All user-facing text should be translatable using Laravel's JSON translation features.

---

## Current Project Status
- **Core Engine:** The foundational logic for multi-step, branching conversational flows is complete. The system can successfully start a flow, process user replies, and navigate between screens.
- **Meta-First Template/Flow Management:** The platform now supports importing approved Message Templates and Flows directly from Meta. These imported assets serve as the blueprints for Service Types and are cloned for new Providers.
- **WhatsApp API Integration:** The project now uses the `netflie/whatsapp-cloud-api` package for all outgoing WhatsApp communications. The `WhatsAppApiService` acts as a wrapper around this library, providing methods for sending various message types (text, images, documents, flows, etc.).
- **Database Schema:** The database schema is implemented, with all major models (`ServiceType`, `Provider`, `Flow`, `FlowVersion`, `Automation`, `AutomationStep`, etc.) in place.
- **Admin Panel:** Basic Filament resources for managing core models have been created, including a new `AutomationResource` with a process builder.
- **Onboarding & Routing:** The `ProviderOnboardingService` and the `TriggerResolver` for keyword-based routing are functional and adapted to the Meta-first approach.
- **Security:** Webhook signature validation is implemented, using helpers from the new WhatsApp library where applicable.
- **Data Interpolation:** The `FlowRenderer` can substitute variables from the session `context` into message text (e.g., `Welcome, {{name}}!`).
- **External API Adapter:** The `FlowActionService` provides a pattern for making external API calls from within a flow, including automatic injection of provider credentials.
- **Improved Fallback Handler:** The `WhatsAppMessageHandler` now lists available keywords for the provider in the fallback message to better guide the user.
- **Codebase Cleanup:** Redundant code and outdated Filament resources have been removed.

---

## High-Level Goals (Next Steps)
1.  **Complete Automations Feature:** This is the current top priority. The implementation will involve:
    -   **API Endpoint:** Create a secure `POST /api/automations/trigger` endpoint and an `AutomationTriggerController`. This controller will validate the request, find the appropriate `Automation`, and dispatch a background job.
    -   **Background Job Processing:**
        -   Create a `ProcessAutomationJob` to orchestrate the execution of the automation's steps.
        -   Create a delayed `ExecuteAutomationStepJob` to handle the execution of individual steps, respecting the `delay_minutes` configuration.
    -   **Action Execution Service:** Create an `AutomationActionService` with methods to handle each `action_type` (e.g., `send_message_template`, `start_flow`), including data interpolation from the trigger payload.
2.  **Implement Message Template Sending (from Flow Builder):** The `WhatsAppApiService` can send pre-approved templates, but there is no UI or flow action to trigger this from within a conversational flow. A new 'Send Template' component should be added to the Flow Builder.

---

## Suggested Libraries & Tools
For future consideration, these packages could be highly beneficial for the project:

- **`spatie/laravel-medialibrary`**: As the platform grows, you'll need to handle media sent *by users* (e.g., images for support tickets). This library is the industry standard in the Laravel ecosystem for managing file uploads and associating them with models.
- **`spatie/laravel-activitylog`**: For a multi-tenant platform, having a clear audit trail is crucial. This package makes it incredibly easy to log all significant actions performed by users and admins.
- **`tenancy/multi-tenant`**: The project currently handles multi-tenancy manually by scoping queries with `provider_id`. For true data separation and scalability, a dedicated tenancy package like this one is the gold standard. It can automatically handle database connections, routing, and data scoping for each tenant.
- **`laravel/horizon`**: The project uses database queues. As traffic increases, you will need a more robust queue monitoring and management solution. Horizon provides a beautiful dashboard and code-driven configuration for your Redis queues.
