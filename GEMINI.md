# Project Overview: Multi-Tenant WhatsApp Platform

## Core Purpose
This is a Laravel-based backend for a multi-tenant WhatsApp messaging service. Its goal is to provide a scalable platform for various business types ('Service Types') to deploy and manage custom interactive WhatsApp 'Flows' for their clients ('Providers').

---

## Key Concepts & Terminology
- **Service Type:** The top-level business category (e.g., 'Food Delivery', 'Clinic Appointments', 'Retail'). This entity defines the master templates for flows, messages, and custom data fields for that business type.
- **Provider:** The end-customer or business using our platform (e.g., 'Slice Pizza', 'City Clinic'). A Provider belongs to exactly one `Service Type`.
- **Flow:** A Provider's unique, editable instance of a conversation. It is generated by copying a `Base Flow Template` when the provider is onboarded.
- **Base Flow Template:** The master, un-editable flow definition (stored as JSON) that lives on the `Service Type`. It acts as the starting point for all providers of that type.
- **Custom Attributes:** Dynamic data fields defined by a `Service Type` (e.g., a 'patient_id' field for clinics, or a 'table_number' for restaurants) that can be used in their flows.
- **FlowComponent:** Individual UI/logic blocks within a flow (e.g., Text Input, Dropdown, Date Picker).

---

## Main Workflow
1.  **Admin Onboarding:** An admin creates a `Service Type` and configures its `Base Flow Template`, `Custom Attributes`, and all necessary translated system messages (welcome, update, etc.).
2.  **Provider Onboarding:** An admin creates a `Provider` and assigns it to a `Service Type`. The system automatically **copies** the `Base Flow Template` to create a new, editable `Flow` record linked to this `Provider`.
3.  **Message Handling:** A WhatsApp message arrives at the webhook. The system identifies the `Provider`, loads their specific `Flow` and their `Service Type`'s configuration.
4.  **System Messages:** When a system message (like a welcome or update) is needed, the system uses the appropriate translated message template from the `Provider's` `Service Type`.

---

## Coding Style & Rules
- **Dependency Injection:** Always use constructor injection for services. Do not use `new Service()`.
- **Testing:** All new business logic should be covered by PestPHP tests.
- **Security:** All incoming webhooks must be validated using their signature. All user input must be validated.
- **Logging:** Log all important events and especially errors to help with debugging.
- **Translations:** All user-facing text should be translatable using Laravel's JSON translation features.

---

## High-Level Goals (To-Do)
1.  **Database Schema:** Build the migrations for `service_types`, `providers`, and `flows` tables to support this new architecture.
2.  **Admin Panel (Filament):** Create resources for managing `Service Types` (including editing templates and messages) and `Providers`.
3.  **Onboarding Logic:** Implement the "copy template to new flow" logic that runs when a `Provider` is assigned a `Service Type`.
4.  **Dynamic Message Handling:** Refactor `WhatsAppMessageHandler` to load flows and message templates based on the Provider's assigned `Service Type`.
5.  **Security First:** Implement the webhook signature validation as the top priority.