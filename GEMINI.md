# Project Overview: Multi-Tenant WhatsApp Platform

## Core Purpose
This is a Laravel-based backend for a multi-tenant WhatsApp messaging service. Its goal is to provide a scalable platform for various business types ('Service Types') to deploy and manage custom interactive WhatsApp 'Flows' for their clients ('Providers').

---

## Key Concepts & Terminology
- **Service Type:** The top-level business category (e.g., 'Food Delivery', 'Clinic Appointments', 'Retail'). This entity defines the master templates for flows, messages, and custom data fields for that business type.
- **Provider:** The end-customer or business using our platform (e.g., 'Slice Pizza', 'City Clinic'). A Provider belongs to exactly one `Service Type`.
- **Flow:** A Provider's unique, editable instance of a conversation. It is generated by copying a `Base Flow Template` when the provider is onboarded.
- **Base Flow Template:** The master, un-editable flow definition (stored as JSON) that lives on the `Service Type`. It acts as the starting point for all providers of that type.
- **Custom Attributes:** Dynamic data fields defined by a `Service Type` (e.g., a 'patient_id' field for clinics, or a 'table_number' for restaurants) that can be used in their flows.
- **FlowComponent:** Individual UI/logic blocks within a flow (e.g., Text Input, Dropdown, Date Picker).

---

## Main Workflow
1.  **Admin Onboarding:** An admin creates a `Service Type` and configures its `Base Flow Template`, `Custom Attributes`, and all necessary translated system messages (welcome, update, etc.).
2.  **Provider Onboarding:** An admin creates a `Provider` and assigns it to a `Service Type`. The system automatically **copies** the `Base Flow Template` to create a new, editable `Flow` record linked to this `Provider`.
3.  **Message Handling:** A WhatsApp message arrives at the webhook. The system identifies the `Provider`, loads their specific `Flow` and their `Service Type`'s configuration.
4.  **System Messages:** When a system message (like a welcome or update) is needed, the system uses the appropriate translated message template from the `Provider's` `Service Type`.

---

## Coding Style & Rules
- **Dependency Injection:** Always use constructor injection for services. Do not use `new Service()`.
- **Testing:** All new business logic should be covered by PestPHP tests.
- **Security:** All incoming webhooks must be validated using their signature. All user input must be validated.
- **Logging:** Log all important events and especially errors to help with debugging.
- **Translations:** All user-facing text should be translatable using Laravel's JSON translation features.

---

## Current Project Status
- **Core Engine:** The foundational logic for multi-step, branching conversational flows is complete and tested. The system can successfully start a flow, process user replies, and navigate between screens based on choices.
- **Database Schema:** The database schema is implemented, with all major models (`ServiceType`, `Provider`, `Flow`, `FlowVersion`, etc.) in place.
- **Admin Panel:** Basic Filament resources for managing core models have been created.
- **Onboarding & Routing:** The `ProviderOnboardingService` and the `TriggerResolver` for keyword-based routing are functional.
- **Security:** Webhook signature validation is implemented.

---

## High-Level Goals (Next Steps)
1.  **Enhance the Flow Builder UI:** Create a user-friendly interface in the Filament admin panel for non-developers to visually build and manage conversational flows. This is the highest priority.
2.  **Implement Data Interpolation:** Update the `FlowRenderer` to substitute variables from the session `context` into message text (e.g., `Welcome, {{name}}!`).
3.  **Develop an External API Adapter Strategy:** Define a pattern for making external API calls from within a flow (e.g., a new `ApiAction` component) to fetch or send data to provider systems.
4.  **Centralize System Messages:** Refactor the `WhatsAppMessageHandler` to pull all user-facing strings (error messages, prompts) from the `message_templates` field on the `ServiceType` model.
